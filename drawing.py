"""
–ë—É–¥—É –ø—Ä–µ–¥–µ–ª—å–Ω–æ –ø—Ä—è–º–æ–ª–∏–Ω–µ–µ–Ω: —ç—Ç–æ —Å–∞–º—ã–π —É–∂–∞—Å–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è —Å–æ—Ç–≤–æ—Ä–∏–ª –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è. –Ø –≤–æ–æ–±—â–µ –Ω–µ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –∏
–∑–∞—á–µ–º –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. –ù–æ –µ—Å–ª–∏ —É—á–µ—Å—Ç—å, —á—Ç–æ –æ–Ω –Ω–∞–ø–∏—Å–∞–Ω —Å–ø—É—Å—Ç—è 3 —á–∞—Å–∞ –ø–æ—Å–ª–µ –¥—ç–¥–ª–∞–π–Ω–∞ –∏ –Ω—É–∂–µ–Ω –ª–∏—à—å –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã
–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä—É—á–Ω—É—é —Ä–∞–±–æ—Ç—É, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –µ–≥–æ —è —Å–º—ã—Å–ª–∞ –Ω–µ –≤–∏–∂—É
"""

import random
import asyncio
import santa

from aiogram import types
from db import Santa, Drawing, Polling, get_non_voting
from dispatcher import bot

db = Santa()
db_drawing = Drawing()
db_polling = Polling()


def get_pairs() -> list[tuple[int, int, bool]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π —Å –ø–∞—Ä–∞–º–∏ —Å–∞–Ω—Ç–∞ - –ø–æ–¥–æ–ø–µ—á–Ω—ã–π –∏ —Ñ–ª–∞–≥–æ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –Ω–∞ –≤—Å—Ç—Ä–µ—á–µ
    –ó–∞—á–µ–º –Ω–∞–º –∑–¥–µ—Å—å –Ω—É–∂–µ–Ω —Ñ–ª–∞–≥ - –≤ –¥—É—à–µ –Ω–µ —á–∞—é, –Ω–æ –∫ —Ç—Ä–µ–º —É—Ç—Ä–∞ —è —É–∂–µ –ø–æ—Ç–µ—Ä—è–ª —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ —Ä–∞—Å—Å—É–¥–∫—É

    :return: [(—Å–∞–Ω—Ç–∞, –ø–æ–¥–æ–ø–µ—á–Ω—ã–π, on_meeting), ]
    """
    players_on_meeting, players_out_meeting = [], []
    pairs = []
    on_meeting_flag = False

    for player in db.get_players():
        # –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —Ü–∏–∫–ª–æ–º, –Ω–æ –≤–æ-–ø–µ—Ä–≤—ã—Ö –∏ —Ç–∞–∫ —Å–æ–π–¥–µ—Ç, –∞ –≤–æ-–≤—Ç–æ—Ä—ã—Ö, –Ω—É–∂–Ω–æ –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—é
        if player[1]:
            players_on_meeting.append(player[0])
        else:
            players_out_meeting.append(player[0])

    for players in (players_out_meeting, players_on_meeting):
        random.shuffle(players)
        pairs.append((players[-1], players[0], on_meeting_flag))

        for i in range(len(players) - 1):
            pairs.append((players[i], players[i + 1], on_meeting_flag))
        on_meeting_flag = True

    return pairs


def add_pairs(pairs: list[tuple[int, int, bool]]) -> None:
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –≤ –±–¥ drawing –ø–∞—Ä—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    –ó–ê–ß–ï–ú –Ø –°–û–ó–î–ê–õ –ï–©–ï –û–î–ù–£ –ë–î?!?!

    :param pairs: [(master, slave, on_meeting),]
    :return: None
    """
    counter = 0

    for pair in pairs:
        db_drawing.add_pair(pair)
        counter += 1
    print(f'INFO: {counter} pairs were added to the database')


def get_mes_text(slave_id: int, on_meeting: bool) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å–ª—ç–π–≤–∞

    :param slave_id: –∞–π–¥–∏—à–Ω–∏–∫ —Å–ª—ç–π–≤–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –¥–µ—Ä–≥–∞–µ–º –∏–Ω—Ñ—É
    :param on_meeting: –±—É–¥–µ—Ç –ª–∏ —Å–ª—ç–π–≤ –Ω–∞ –≤—Å—Ç—Ä–µ—á–µ
    :return: —Ç–µ–∫—Å—Ç
    """
    data = db.get_info(slave_id)

    txt_out = f'''<b>–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥!</b> –ú—ã –ø—Ä–æ–∏–∑–≤–µ–ª–∏ –∂–µ—Ä–µ–±—å—ë–≤–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã "–¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞ "–ú–∞–≥–∏—Å—Ç—Ä–∞". –¢–µ–ø–µ—Ä—å –º—ã –∑–Ω–∞–µ–º, –∫—Ç–æ –∏ –∫–æ–º—É –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫. –°–ø–µ—à–∏–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∏ —Ç–µ–±–µ!

–í–æ—Ç –∫–∞–∫ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É —Ç—ã –¥–µ–ª–∞–µ—à—å –ø–æ–¥–∞—Ä–æ–∫.

<b>–§–ò–û:</b> <i>{data[0]}</i>
<b>–ü–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å:</b> <i>{data[1]}</i>
<b>–ü—Ä–∏–µ–¥–µ—Ç –ª–∏ –Ω–∞ –æ–±—â–µ–ª–∞–≥–µ—Ä–Ω—É—é –≤—Å—Ç—Ä–µ—á—É:</b> –Ω–µ—Ç. –°–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ –ø–æ—á—Ç–µ.

<b>–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –ø–æ–¥–∞—Ä–∫—É:</b> <i>"{data[2]}"</i>

<i>–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã –æ—Ç–ø—Ä–∞–≤–∏—à—å –ø–æ–¥–∞—Ä–æ–∫, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª!" –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.</i>'''
    txt_on = f'''<b>–ü—Ä–∏–≤–µ—Ç, –¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥!</b> –ú—ã –ø—Ä–æ–∏–∑–≤–µ–ª–∏ –∂–µ—Ä–µ–±—å—ë–≤–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–≥—Ä—ã "–¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞ "–ú–∞–≥–∏—Å—Ç—Ä–∞". –¢–µ–ø–µ—Ä—å –º—ã –∑–Ω–∞–µ–º, –∫—Ç–æ –∏ –∫–æ–º—É –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫. –°–ø–µ—à–∏–º —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∏ —Ç–µ–±–µ!

–í–æ—Ç –∫–∞–∫ —Ç—ã –º–æ–∂–µ—à—å –Ω–∞–π—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É —Ç—ã –¥–µ–ª–∞–µ—à—å –ø–æ–¥–∞—Ä–æ–∫.

<b>–§–ò–û:</b> <i>{data[0]}</i>
<b>–ü–æ—á—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å:</b> <i>{data[1]}</i>
<b>–ü—Ä–∏–µ–¥–µ—Ç –ª–∏ –Ω–∞ –æ–±—â–µ–ª–∞–≥–µ—Ä–Ω—É—é –≤—Å—Ç—Ä–µ—á—É:</b> –î–∞!

<b>–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –ø–æ–¥–∞—Ä–∫—É:</b> <i>"{data[2]}"</i>
–°–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ —Ç—ã –º–æ–∂–µ—à—å –∫–∞–∫ –æ—Ç–¥–∞—Ç—å –ª–∏—á–Ω–æ –Ω–∞ –≤—Å—Ç—Ä–µ—á–µ, —Ç–∞–∫ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –ø–æ –ø–æ—á—Ç–µ.

<i>–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç—ã –æ—Ç–ø—Ä–∞–≤–∏—à—å –ø–æ–¥–∞—Ä–æ–∫, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–Ø –æ—Ç–ø—Ä–∞–≤–∏–ª!" –ø–æ–¥ —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.</i>'''

    return txt_on if on_meeting else txt_out


async def sent_alerts(pairs: list[tuple[int, int, bool]]) -> None:
    """
    –†–∞—Å—Å—ã–ª–∞–µ—Ç —é–∑–µ—Ä–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ–π –ø—Ä–æ –∏—Ö —Å–ª—ç–π–≤–∞

    :param pairs: [(—Å–∞–Ω—Ç–∞, –ø–æ–¥–æ–ø–µ—á–Ω—ã–π, on_meeting), ]
    :return: None
    """
    for pair in pairs:
        await bot.send_message(chat_id=pair[0], text=get_mes_text(pair[1], pair[2]), reply_markup=santa.sent_btn)
        await bot.close()  # –∂—É—Ç–∫–∏–π –∫–æ—Å—Ç—ã–ª—å, –Ω–æ –±–µ–∑ –Ω–µ–≥–æ –≤—Å–µ —Å—ã–ø–µ—Ç—Å—è. –ê —Ç–∞–∫ —Ç–æ–ª—å–∫–æ –≤–∞—Ä–Ω–∏–Ω–≥ –ª–µ—Ç–∏—Ç
        await asyncio.sleep(30)


async def sent_questions() -> None:
    """
    –†–∞—Å—Å—ã–ª–∞–µ—Ç —é–∑–µ—Ä–∞–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞—á–∞–ª–æ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞

    :return: None
    """

    inline_btn_1 = types.InlineKeyboardButton('–Ø —Ö–æ—á—É –æ—Ç–≤–µ—Ç–∏—Ç—å –±–æ—Ç—É!', callback_data='start_pol')
    start_pol_kb = types.InlineKeyboardMarkup().add(inline_btn_1)
    # users = [(385056286, 'dan')]
    # users = db.get_users()
    users = list(get_non_voting())
    print(users)
    for user in users:
        await bot.send_message(chat_id=user, text='''–¢–∞–∫-—Ç–∞–∫, –∞ –∫—Ç–æ —ç—Ç–æ —Ç—É—Ç —É –Ω–∞—Å? üéÖüéÖüéÖ

–ê–≥–∞, –¥–∞ —ç—Ç–æ –∂–µ —Ç–æ—Ç, –∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ "–ú–∞–≥–∏—Å—Ç—Ä–∞" –ø–æ "–¢–∞–π–Ω–æ–º—É –°–∞–Ω—Ç–µ"!

–•–æ-—Ö–æ-—Ö–æ! –ù–æ–≤—ã–π –≥–æ–¥ —É–∂–µ —Å–æ–≤—Å–µ–º –±–ª–∏–∑–∫–æ! –ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π –°–∞–Ω—Ç—É –∏ –î–µ–¥—É—à–∫—É –ú–æ—Ä–æ–∑–∞, –Ω–µ —Ç–æ –æ—Å—Ç–∞–Ω–µ—à—å—Å—è –±–µ–∑ –ø–æ–¥–∞—Ä–∫–æ–≤...''', reply_markup=start_pol_kb)
        print(f'sent to {user}')
        await bot.close()  # –∂—É—Ç–∫–∏–π –∫–æ—Å—Ç—ã–ª—å, –Ω–æ –±–µ–∑ –Ω–µ–≥–æ –≤—Å–µ —Å—ã–ø–µ—Ç—Å—è. –ê —Ç–∞–∫ —Ç–æ–ª—å–∫–æ –≤–∞—Ä–Ω–∏–Ω–≥ –ª–µ—Ç–∏—Ç
        await asyncio.sleep(15)


if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.run_until_complete(sent_questions())
    loop.close()
